{"version":3,"file":"tobago-page.js","sourceRoot":"../ts/","sources":["tobago-page.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements.  See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License.  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CommandHelper} from \"./tobago-command\";\nimport {Overlay} from \"./tobago-overlay\";\nimport {Listener} from \"./tobago-listener\";\nimport {ReloadManager} from \"./tobago-reload\";\n\nexport class Page extends HTMLElement {\n\n  private transition: boolean;\n  private oldTransition: boolean;\n\n  /**\n   * The Tobago root element\n   */\n  static page(element: HTMLElement): Page {\n    const rootNode = element.getRootNode() as ShadowRoot | Document;\n    const pages = rootNode.querySelectorAll(\"tobago-page\");\n    if (pages.length > 0) {\n      if (pages.length >= 2) {\n        console.warn(\"Found more than one tobago-page element!\");\n      }\n      return pages.item(0) as Page;\n    }\n    console.warn(\"Found no tobago page!\");\n    return null;\n  }\n\n  /**\n   * \"a:b\" -> \"a\"\n   * \"a:b:c\" -> \"a:b\"\n   * \"a\" -> null\n   * null -> null\n   * \"a:b::sub-component\" -> \"a\"\n   * \"a::sub-component:b\" -> \"a::sub-component\" // should currently not happen in Tobago\n   *\n   * @param clientId The clientId of a component.\n   * @return The clientId of the naming container.\n   */\n  static getNamingContainerId(clientId: string): string {\n    if (clientId == null || clientId.lastIndexOf(\":\") === -1) {\n      return null;\n    }\n\n    let id = clientId;\n    while (true) {\n      const sub = id.lastIndexOf(\"::\");\n      if (sub == -1) {\n        break;\n      }\n      if (sub + 1 == id.lastIndexOf(\":\")) {\n        id = id.substring(0, sub);\n      } else {\n        break;\n      }\n    }\n    return id.substring(0, id.lastIndexOf(\":\"));\n  }\n\n  constructor() {\n    super();\n  }\n\n  connectedCallback(): void {\n\n    this.registerAjaxListener();\n\n    this.querySelector(\"form\").addEventListener(\"submit\", CommandHelper.onSubmit);\n\n    window.addEventListener(\"unload\", this.onUnload.bind(this));\n\n    this.addEventListener(\"keypress\", (event: KeyboardEvent): boolean => {\n      let code = event.which; // XXX deprecated\n      if (code === 0) {\n        code = event.keyCode;\n      }\n      if (code === 13) {\n        const target = event.target as HTMLElement;\n        if (target.tagName === \"A\" || target.tagName === \"BUTTON\") {\n          return;\n        }\n        if (target.tagName === \"TEXTAREA\") {\n          if (!event.metaKey && !event.ctrlKey) {\n            return;\n          }\n        }\n        const name = target.getAttribute(\"name\");\n        let id = name ? name : target.id;\n        while (id != null) {\n          const command = document.querySelector(\"[data-tobago-default='\" + id + \"']\");\n          if (command) {\n            command.dispatchEvent(new MouseEvent(\"click\"));\n            break;\n          }\n          id = Page.getNamingContainerId(id);\n        }\n        return false;\n      }\n    });\n\n    // todo remove this\n    Listener.executeDocumentReady(document.documentElement);\n  }\n\n  onBeforeUnload(): void {\n    if (this.transition) {\n      new Overlay(this);\n    }\n    this.transition = this.oldTransition;\n  }\n\n  /**\n   * Wrapper function to call application generated onunload function\n   */\n  onUnload(): void {\n    console.info(\"on onload\");\n    if (CommandHelper.isSubmit) {\n      if (this.transition) {\n        new Overlay(this);\n      }\n      this.transition = this.oldTransition;\n    } else {\n      Listener.executeBeforeExit();\n    }\n  }\n\n  registerAjaxListener(): void {\n    jsf.ajax.addOnEvent(this.jsfResponse.bind(this));\n  }\n\n  jsfResponse(event: EventData): void {\n    console.timeEnd(\"[tobago-jsf] jsf-ajax\");\n    console.time(\"[tobago-jsf] jsf-ajax\");\n    console.debug(\"[tobago-jsf] JSF event status: '%s'\", event.status);\n    if (event.status === \"success\") {\n      event.responseXML.querySelectorAll(\"update\").forEach(this.jsfResponseSuccess.bind(this));\n    } else if (event.status === \"complete\") {\n      event.responseXML.querySelectorAll(\"update\").forEach(this.jsfResponseComplete.bind(this));\n    }\n  }\n\n  jsfResponseSuccess(update: Element): void {\n    const result = /<!\\[CDATA\\[(.*)]]>/gm.exec(update.innerHTML);\n    const id = update.id;\n    if (result !== null && result.length === 2 && result[1].startsWith(\"{\\\"reload\\\"\")) {\n      // not modified on server, needs be reloaded after some time\n      console.debug(\"[tobago-jsf] Found reload-JSON in response!\");\n      ReloadManager.instance.schedule(id, JSON.parse(result[1]).reload.frequency);\n    } else {\n      console.info(\"[tobago-jsf] Update after jsf.ajax success: %s\", id);\n      if (JsfParameter.isJsfId(id)) {\n        console.debug(\"[tobago-jsf] updating #%s\", id);\n        const rootNode = this.getRootNode() as ShadowRoot | Document;\n        const element = rootNode.getElementById(id);\n        if (element) {\n          Listener.executeAfterUpdate(element);\n        } else {\n          console.warn(\"[tobago-jsf] element not found for #%s\", id);\n        }\n      } else if (JsfParameter.isJsfBody(id)) {\n        console.debug(\"[tobago-jsf] updating body\");\n        // there should be only one element with this tag name\n        const rootNode = this.getRootNode() as ShadowRoot | Document;\n        Listener.executeAfterUpdate(rootNode.querySelector(\"tobago-page\") as HTMLElement);\n      }\n    }\n  }\n\n  jsfResponseComplete(update: Element): void {\n    const id = update.id;\n    if (JsfParameter.isJsfId(id)) {\n      console.debug(\"[tobago-jsf] Update after jsf.ajax complete: #\" + id);\n      Overlay.destroy(id);\n    }\n  }\n\n  get locale(): string {\n    let locale = this.getAttribute(\"locale\");\n    if (!locale) {\n      locale = document.documentElement.lang;\n    }\n    return locale;\n  }\n}\n\ndocument.addEventListener(\"tobago.init\", (event: Event): void => {\n  if (window.customElements.get(\"tobago-page\") == null) {\n    window.customElements.define(\"tobago-page\", Page);\n  }\n});\n\n// todo remove this\nwindow.addEventListener(\"load\", Listener.executeWindowLoad);\n\nclass JsfParameter {\n\n  static VIEW_STATE = \"javax.faces.ViewState\";\n  static CLIENT_WINDOW = \"javax.faces.ClientWindow\";\n  static VIEW_ROOT = \"javax.faces.ViewRoot\";\n  static VIEW_HEAD = \"javax.faces.ViewHead\";\n  static VIEW_BODY = \"javax.faces.ViewBody\";\n  static RESOURCE = \"javax.faces.Resource\";\n\n  static isJsfId(id: string): boolean {\n    switch (id) {\n      case JsfParameter.VIEW_STATE:\n      case JsfParameter.CLIENT_WINDOW:\n      case JsfParameter.VIEW_ROOT:\n      case JsfParameter.VIEW_HEAD:\n      case JsfParameter.VIEW_BODY:\n      case JsfParameter.RESOURCE:\n        return false;\n      default:\n        return true;\n    }\n  }\n\n  static isJsfBody(id): boolean {\n    switch (id) {\n      case JsfParameter.VIEW_ROOT:\n      case JsfParameter.VIEW_BODY:\n        return true;\n      default:\n        return false;\n    }\n  }\n}\n"]}