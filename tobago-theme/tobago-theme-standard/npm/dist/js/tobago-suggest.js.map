{"version":3,"file":"tobago-suggest.js","sourceRoot":"../ts/","sources":["tobago-suggest.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements.  See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License.  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Autocomplete from \"@trevoreyre/autocomplete-js\";\n\nexport class Suggest {\n\n  autocomplete: Autocomplete;\n  tobagoIn: HTMLElement;\n  resolve: any;\n\n  constructor(tobagoIn: HTMLElement) {\n    this.tobagoIn = tobagoIn;\n  }\n\n  public init(): void {\n    if (!this.suggest) {\n      console.warn(\"[tobago-suggest] could not find tobago-suggest\");\n      return;\n    }\n\n    this.registerAjaxListener();\n    this.base.classList.add(\"autocomplete\");\n    this.base.insertAdjacentHTML(\"afterbegin\", `<div class=\"autocomplete-pseudo-container\"></div>`);\n    this.suggestInput.classList.add(\"autocomplete-input\");\n    this.suggestInput.insertAdjacentHTML(\"afterend\", `<ul class=\"autocomplete-result-list\"></ul>`);\n\n    const options = {\n      search: input => {\n        console.debug(\"[tobago-suggest] input = '\" + input + \"'\");\n        const minChars = this.minChars ? this.minChars : 1;\n        if (input.length < minChars) {\n          return [];\n        }\n        this.hiddenInput.value = input.toLowerCase();\n\n        this.positioningSpinner();\n\n        return new Promise(resolve => {\n          if (input.length < 1) {\n            return resolve([]);\n          }\n\n          if (this.update) {\n            this.resolve = resolve;\n            const suggestId = this.suggest.id;\n            jsf.ajax.request(suggestId, null, {\n              \"javax.faces.behavior.event\": \"suggest\",\n              execute: suggestId,\n              render: suggestId\n            });\n          } else {\n            return resolve(this.filterItems());\n          }\n        });\n      },\n      onUpdate: (results, selectedIndex) => {\n        this.positioningResultList();\n        this.setResultListMaxHeight();\n      },\n      debounceTime: this.delay\n    };\n\n    new Autocomplete(this.base, options);\n    if (!this.localMenu) {\n      this.menuStore.append(this.resultList);\n    }\n  }\n\n  private registerAjaxListener(): void {\n    jsf.ajax.addOnEvent(this.resolvePromise.bind(this));\n  }\n\n  private resolvePromise(event: EventData): void {\n    if (event.source === this.suggest && event.status === \"success\") {\n      return this.resolve(this.filterItems());\n    }\n  }\n\n  private filterItems(): string[] {\n    return this.items.filter(item => {\n      return item.toLowerCase().indexOf(this.hiddenInput.value) > -1;\n    });\n  }\n\n  private positioningSpinner(): void {\n    const baseRect = this.base.getBoundingClientRect();\n    const suggestInputRect = this.suggestInput.getBoundingClientRect();\n    const suggestInputStyle = getComputedStyle(this.suggestInput);\n    this.pseudoContainer.style.left = suggestInputRect.x - baseRect.x + suggestInputRect.width\n        - parseFloat(getComputedStyle(this.pseudoContainer, \":after\").width)\n        - parseFloat(suggestInputStyle.marginRight)\n        - parseFloat(suggestInputStyle.borderRight)\n        - parseFloat(suggestInputStyle.paddingRight) + \"px\";\n    this.pseudoContainer.style.top = suggestInputRect.y - baseRect.y + (suggestInputRect.height / 2) + \"px\";\n  }\n\n  private positioningResultList(): void {\n    const space: number = 2;\n\n    if (this.localMenu) {\n      const parentRect = this.suggestInput.parentElement.getBoundingClientRect();\n      const suggestInputRect = this.suggestInput.getBoundingClientRect();\n      this.resultList.style.marginLeft = (suggestInputRect.x - parentRect.x) + \"px\";\n      this.resultList.style.maxWidth = suggestInputRect.width + \"px\";\n      this.resultList.style.marginTop = space + \"px\";\n      this.resultList.style.marginBottom = space + \"px\";\n    } else {\n      const suggestInputRect = this.suggestInput.getBoundingClientRect();\n      this.resultList.style.minWidth = suggestInputRect.width + \"px\";\n      this.resultList.style.left = suggestInputRect.left + \"px\";\n      if (this.resultListPosition === \"below\") {\n        this.resultList.style.marginTop =\n            window.scrollY + suggestInputRect.top + suggestInputRect.height + space + \"px\";\n        this.resultList.style.marginBottom = null;\n      } else if (this.resultListPosition === \"above\") {\n        this.resultList.style.marginTop = null;\n        this.resultList.style.marginBottom = -(window.scrollY + suggestInputRect.top - space) + \"px\";\n      }\n    }\n  }\n\n  private setResultListMaxHeight(): void {\n    const resultListEntry = this.resultList.querySelector(\".autocomplete-result\");\n    if (this.maxItems && resultListEntry) {\n      const resultListStyle = getComputedStyle(this.resultList);\n      this.resultList.style.maxHeight = (\n          parseFloat(resultListStyle.borderTop)\n          + parseFloat(resultListStyle.paddingTop)\n          + (this.maxItems * parseFloat(getComputedStyle(resultListEntry).height))\n          + parseFloat(resultListStyle.paddingBottom)\n          + parseFloat(resultListStyle.borderBottom)) + \"px\";\n    }\n  }\n\n  private get base(): HTMLElement {\n    return this.tobagoIn;\n  }\n\n  private get pseudoContainer(): HTMLDivElement {\n    return this.base.querySelector(\":scope > .autocomplete-pseudo-container\");\n  }\n\n  private get suggestInput(): HTMLInputElement {\n    const root = this.base.getRootNode() as ShadowRoot | Document;\n    return root.getElementById(this.suggest.getAttribute(\"for\")) as HTMLInputElement;\n  }\n\n  private get suggest(): HTMLElement {\n    return this.base.querySelector(\"tobago-suggest\");\n  }\n\n  private get hiddenInput(): HTMLInputElement {\n    return this.suggest.querySelector(\":scope > input[type=hidden]\");\n  }\n\n  private get items(): string[] {\n    return JSON.parse(this.suggest.getAttribute(\"items\"));\n  }\n\n  private get resultList(): HTMLUListElement {\n    const root = this.base.getRootNode() as ShadowRoot | Document;\n    const resultListId = this.suggestInput.getAttribute(\"aria-owns\");\n    return root.getElementById(resultListId) as HTMLUListElement;\n  }\n\n  private get resultListPosition(): string {\n    return this.base.dataset.position;\n  }\n\n  private get menuStore(): HTMLDivElement {\n    const root = this.base.getRootNode() as ShadowRoot | Document;\n    return root.querySelector(\".tobago-page-menuStore\");\n  }\n\n  private get update(): boolean {\n    return this.suggest.getAttribute(\"update\") !== null;\n  }\n\n  private get delay(): number {\n    return parseInt(this.suggest.getAttribute(\"delay\"));\n  }\n\n  private get maxItems(): number {\n    return parseInt(this.suggest.getAttribute(\"max-items\"));\n  }\n\n  private get minChars(): number {\n    return parseInt(this.suggest.getAttribute(\"min-chars\"));\n  }\n\n  private get localMenu(): boolean {\n    return this.suggest.getAttribute(\"local-menu\") !== null;\n  }\n}\n"]}